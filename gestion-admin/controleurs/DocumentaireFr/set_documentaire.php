<?phpsession_start();session_regenerate_id();require_once './../../connection/config_vod.php';ini_set('date.timezone', 'Europe/Paris');/* * *********************** Donnes recus par le navigateur client *************************** */$section_film = $_POST['section_film'];$titre_original = $_POST['titre_original']; // nouveau$nv_nom_fichier = $_POST['nv_nom_fichier']; //nouveau nom complet$taille_fichier = $_POST['taille_fichier'];$nom_fichier_complet = $_POST['nom_fichier_complet']; // ancien nom  complet$genre_doc = $_POST['genre_doc']; // genre doc$idtmd = $_POST['idtmd'];$id_serveur = $_POST['serveur_film'];$langage = 'VF';if (isset($_POST['collection_fichier']) && !empty($_POST['collection_fichier'])) {    $collection_fichier = $_POST['collection_fichier'];} else {    $collection_fichier = NULL;}$droit = 0777;$fichierExtension = '.strm';if ($_SERVER['SERVER_NAME'] == 'localhost') {    $dir = "C:/wamp64/www/MegaTV-Backend/Media-Vod/DocumentaireFr/";    $source_fichier = "C:/wamp64/www/MegaTV-Backend/Media-Vod/DocumentaireFr/";    $fichierChemin = 'C:/wamp64/www/MegaTV-Backend/Kodi_strm/DocumentaireFr/';    $dir_jaquette = 'C:/wamp64/www/MegaTV-Backend/gestion-admin/images/JaquetteDoc/';} else {    $dir = "/volume1/web/media/DocumentaireFr/";    $source_fichier = '/web/media/DocumentaireFr/';    $fichierChemin = '/volume1/web/Kodi_strm/DocumentaireFr/';    $dir_jaquette = '/volume1/web/Megatv/MegatvProcedural/gestion-admin/images/JaquetteDoc/';}/* * ******************* fonction upload ************************************ */function upload_fichier($FILES, $upload_dir, $id_image) {    // var_dump($FILES);    $controle = TRUE;    $imgFile = $FILES['name'];    $tmp_dir = $FILES['tmp_name'];    $imgSize = $FILES['size'];    if (!empty($imgFile)) {        $imgExt = strtolower(pathinfo($imgFile, PATHINFO_EXTENSION)); // get image extension        // valid image extensions        $valid_extensions = array('jpeg', 'jpg', 'png', 'gif'); // valid extensions           // allow valid image file formats        if (in_array($imgExt, $valid_extensions)) {            // Check file size '5MB'            if ($imgSize < 5000000) {                $distination_img = $upload_dir . 'poster_' . $id_image . '.' . $imgExt;                if (file_exists($distination_img)) {                    unlink($distination_img);                }                if (!move_uploaded_file($tmp_dir, $distination_img)) {                    $controle = FALSE;                    //echo 'entre-2';                }            }        }    }    return $controle;}/* * ***************************************************************************************************** */function creerFichierStrm($fichierChemin, $fichierNom, $fichierExtension, $fichierContenu, $droit = "") {    $fichierCheminComplet = $fichierChemin . $fichierNom . $fichierExtension;// création du fichier sur le serveur    $leFichier = fopen($fichierCheminComplet, "wb");    fwrite($leFichier, $fichierContenu);    fclose($leFichier);// la permission    if ($droit == "") {        $droit = 0777;    }// on vérifie que le fichier a bien été créé    $t_infoCreation['fichierCreer'] = false;    if (file_exists($fichierCheminComplet) == true) {        $t_infoCreation['fichierCreer'] = true;    }// on applique les permission au fichier créé    $retour = chmod($fichierCheminComplet, $droit);    // var_dump($retour);    $t_infoCreation['permissionAppliquer'] = $retour;    return $t_infoCreation;}//ftp://achachia2003:7130chachia@pool182.seedbox.fr:21/VOD/FilmsArabic/Ahwak.HD.720p.mkv//dav://myvod69800%40netcmail.com:myvod69800@webdav.4shared.com:80/Jupiter.Ascending.avi// recuperation des informations de la source et compte$etat = TRUE;$date_upload = date("Y-m-d");$objet = array();/*********************************************************************************/$json_source = file_get_contents('https://api.themoviedb.org/3/movie/' . $idtmd . '?api_key=cf673ba3b2a3baceeeefa90d7460cd10&language=fr');// Décode le JSON$json_data = json_decode($json_source);/***************************************************/    $tab = explode("-", $json_data->release_date);    $annee_release = $tab[0];    $overview = $json_data->overview;/* * **************** Recuperer url serveur ****************************************** */try {    $sql = " SELECT url_serveur FROM  ListeServeursVod  WHERE  id_serveur=:param";    $stmt = $cxn->prepare($sql);    $stmt->bindParam(':param', $id_serveur);    $stmt->execute();    $enregistrement = $stmt->fetch();    $url_serveur = $enregistrement['url_serveur'];} catch (Exception $ex) {    $etat = FALSE;    echo $ex->getMessage();}$url = $url_serveur . '/DocumentaireFr/' . $nv_nom_fichier;/* * *********** recuperer les informations de host-user *********************** */try {    $sql = " SELECT * FROM  CompteVod  WHERE  code_user=:param";    $stmt = $cxn->prepare($sql);    $stmt->bindParam(':param', $_SESSION ['user_admin'] ['code_user']);    $stmt->execute();    $enregistrement = $stmt->fetch();    $host = $enregistrement['host'];    $port = $enregistrement['port'];    $protocole = $enregistrement['protocole'];    $user = $enregistrement['user'];    $password = $enregistrement['password'];} catch (Exception $e) {    $etat = FALSE;    echo $e->getMessage();}/* * ********************* Supression fichier strm en cas si il existe  ********************************* */if (isset($_POST['titre_precedant']) && !empty($_POST['titre_precedant'])) {    $titre_precedant = $_POST['titre_precedant'];    $fichierCheminComplet = $fichierChemin . $titre_precedant . $fichierExtension;    if (file_exists($fichierCheminComplet) == true) {        unlink($fichierCheminComplet);    }}/* * ************************************************************************************************************ */if (!empty($_POST['button_register'])) {    $affiche_doc = 'poster_doc_defaut.jpg';    try {        $sql = " INSERT INTO  FichierVod (titre_originale,date_upload,section_fichier,taille_fichier,id_TMD,genre,collection,poster,langage,annee_release,overview) VALUES (:param1,:param2,:param3,:param4,:param5,:param6,:param7,:param8,:param9,:param10,:param11)";        $stmt = $cxn->prepare($sql);        $stmt->bindParam(':param1', $titre_original);        $stmt->bindParam(':param2', $date_upload);        $stmt->bindParam(':param3', $section_film);        $stmt->bindParam(':param4', $taille_fichier);        $stmt->bindParam(':param5', $idtmd);        $stmt->bindParam(':param6', $genre_doc);        $stmt->bindParam(':param7', $collection_fichier);        $stmt->bindParam(':param8', $affiche_doc);        $stmt->bindParam(':param9', $langage);                $stmt->bindParam(':param10', $annee_release);                        $stmt->bindParam(':param11', $overview);        $stmt->execute();        /*         * ******************* Recuperation Id d'enregistrement ***************************** */        try {            $sql = " SELECT MAX(id_fichier) AS MaxId  FROM FichierVod ";            $stmt = $cxn->prepare($sql);            $stmt->execute();            $enregistrement = $stmt->fetch();            $MaxId = $enregistrement['MaxId'];        } catch (Exception $e) {            $etat = FALSE;            $objet ['message_erreur'] [] = 'Probleme dans l\'excution de la requette' . $sql;        }        /*         * ************************ Insertion link server ********************************* */        $date_created = date("Y-m-d");        $qualite_video = $_POST['qualite_video'];        try {            $sql = " INSERT INTO  LinksServersFichierVod (id_fichier,nom_fichier,id_serveur,url,date_created,qualite) VALUES ('" . $MaxId . "','" . $nv_nom_fichier . "','" . $id_serveur . "','" . $url . "','" . $date_created . "','" . $qualite_video . "') ";            $resultat = $cxn->prepare($sql);            $resultat->execute();        } catch (Exception $e) {            echo $e->getMessage();        }        /*         * ********************* Contenu fichier strm Kodi ************************************ */        // creation fichier strm sur le serveur         //  echo $fichierChemin.$titre_original.$fichierExtension.$fichierContenu.$droit;         $fichierContenu = $protocole . '://' . $user . ':' . $password . '@' . $host . ':' . $port . $source_fichier . $nv_nom_fichier;        $t_infoCreation = creerFichierStrm($fichierChemin, $titre_original, $fichierExtension, $fichierContenu, $droit);        if ($t_infoCreation['fichierCreer'] != '1' || $t_infoCreation['permissionAppliquer'] != '1') {            $objet ['message_erreur'] [] = $t_infoCreation['fichierCreer'];            $objet ['message_erreur'] [] = $t_infoCreation['permissionAppliquer'];            $etat = FALSE;            $objet ['message_erreur'] [] = 'Probleme dans la creation de fichier strm dans le serveur';            //  var_dump($objet ['message_erreur']);        }        /*         * ***************************************Renomer le fichier par le nouveau nom sur le serveur  ********************************************************************** */        rename($dir . $nom_fichier_complet, $dir . $nv_nom_fichier);    } catch (Exception $e) {        echo $e->getMessage();        $etat = FALSE;        $objet ['message_erreur'] [] = 'Probleme dans l\'excution de la requette' . $sql;    }}/* * ********************************************************************************************** */if (!empty($_POST['button_update'])) {    /*     * *********************************Mettre a jour le fichier dans la base de donnees*********************************************************** */    try {        if (isset($_POST['id_fichier']) && !empty($_POST['id_fichier'])) {            $id_fichier = $_POST['id_fichier'];            $affiche_doc = $_POST['affiche_doc'];            if (isset($_FILES['affiche_movie']['name']) && !empty($_FILES['affiche_movie']['name'])) {                $imgExt = strtolower(pathinfo($_FILES['affiche_movie']['name'], PATHINFO_EXTENSION));                $affiche_doc = 'poster_' . $id_fichier . '.' . $imgExt;            }        }        $sql = " UPDATE  FichierVod  SET  titre_originale=:param1,section_fichier=:param2,id_TMD=:param3,genre=:param4,collection=:param5,poster=:param6   WHERE id_fichier=:param7";        $stmt = $cxn->prepare($sql);        $stmt->bindParam(':param1', $titre_original);        $stmt->bindParam(':param2', $section_film);        $stmt->bindParam(':param3', $idtmd);        $stmt->bindParam(':param4', $genre_doc);        $stmt->bindParam(':param5', $collection_fichier);        $stmt->bindParam(':param6', $affiche_doc);        $stmt->bindParam(':param7', $id_fichier);        $stmt->execute();    } catch (Exception $e) {        $etat = FALSE;        $objet ['message_erreur'] [] = 'Probleme dans l\'excution de la requette' . $sql;    }    /*     * **************** upload fichier image ********************************** */    if (isset($_FILES['affiche_movie']['name']) && !empty($_FILES['affiche_movie']['name']) && $etat) {        upload_fichier($_FILES['affiche_movie'], $dir_jaquette, $id_fichier);    }    /*     * ********************* Contenu fichier strm Kodi ************************************ */    // creation fichier strm sur le serveur     //  echo $fichierChemin.$titre_original.$fichierExtension.$fichierContenu.$droit;     $droit = 0777;    $fichierExtension = '.strm';    $fichierContenu = $protocole . '://' . $user . ':' . $password . '@' . $host . ':' . $port . $source_fichier . $nv_nom_fichier;    $t_infoCreation = creerFichierStrm($fichierChemin, $titre_original, $fichierExtension, $fichierContenu, $droit);    if ($t_infoCreation['fichierCreer'] != '1' || $t_infoCreation['permissionAppliquer'] != '1') {        $objet ['message_erreur'] [] = $t_infoCreation['fichierCreer'];        $objet ['message_erreur'] [] = $t_infoCreation['permissionAppliquer'];        $etat = FALSE;        $objet ['message_erreur'] [] = 'Probleme dans la creation de fichier strm dans le serveur';        //  var_dump($objet ['message_erreur']);    }    /*     * ***************************************Renomer le fichier par le nouveau nom sur le serveur  ********************************************************************** */    //echo $dir . $nom_fichier_complet;    // var_dump($nv_nom_fichier) ;    rename($dir . $nom_fichier_complet, $dir . $nv_nom_fichier);}if (!empty($_POST['button_delete'])) {    /*     * ****************** Suppression fichier sur le serveur ***************************************** */    $fichierCheminComplet = $dir . $nom_fichier_complet;    if (file_exists($fichierCheminComplet) == true) {        unlink($fichierCheminComplet);    }    /*     * ****************** Suppression enregistrement dans la base de donnees ***************************************** */    if (isset($_POST['id_fichier']) && !empty($_POST['id_fichier'])) {        $id_fichier = $_POST['id_fichier'];        try {            $sql = " DELETE FROM  FichierVod   WHERE id_fichier=:id_fichier";            $stmt = $cxn->prepare($sql);            $stmt->bindParam(':id_fichier', $id_fichier);            $stmt->execute();        } catch (Exception $e) {            $etat = FALSE;            $objet ['message_erreur'] [] = 'Probleme dans l\'excution de la requette' . $sql;        }    }}/* * ******************************************** ***************************************************** */if ($etat) {    $url = $url_espace_admin . "/index.php?module=DocumentaireFr&action=all_documentaire&message=success";} else {    $url = $url_espace_admin . "/index.php?module=DocumentaireFr&action=all_documentaire&message=echec";}header("Location:  $url ");exit();?>