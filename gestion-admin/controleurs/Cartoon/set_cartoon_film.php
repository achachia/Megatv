<?phpsession_start();session_regenerate_id();require_once './../../connection/config_vod.php';ini_set('date.timezone', 'Europe/Paris');/* * *********************** Donnes recus par le navigateur client *************************** */$section_film = $_POST['section_film'];$titre_original = $_POST['titre_original']; // nouveau$nv_nom_fichier = $_POST['nv_nom_fichier']; //nouveau nom complet$taille_fichier = $_POST['taille_fichier'];$nom_fichier_complet = $_POST['nom_fichier_complet']; // ancien nom  complet$idtmd = $_POST['idtmd'];$droit = 0777;$fichierExtension = '.strm';if ($_SERVER['SERVER_NAME'] == 'localhost') {    $dir = "C:/wamp64/www/MegatvProcedural/Media-Vod/Cartoon/";    $source_fichier = "C:/wamp64/www/MegatvProcedural/Media-Vod/Cartoon/";    $fichierChemin = 'C:/wamp64/www/MegatvProcedural/Kodi_strm/Cartoon/';    } else {    $dir = "/volume1/web/media/Cartoon/";    $source_fichier = '/web/media/Cartoon/';    $fichierChemin = '/volume1/web/Kodi_strm/Cartoon/';}/* * ***************************************************************************************************** */function creerFichierStrm($fichierChemin, $fichierNom, $fichierExtension, $fichierContenu, $droit = "") {    $fichierCheminComplet = $fichierChemin . $fichierNom . $fichierExtension;// création du fichier sur le serveur    $leFichier = fopen($fichierCheminComplet, "wb");    fwrite($leFichier, $fichierContenu);    fclose($leFichier);// la permission    if ($droit == "") {        $droit = 0777;    }// on vérifie que le fichier a bien été créé    $t_infoCreation['fichierCreer'] = false;    if (file_exists($fichierCheminComplet) == true) {        $t_infoCreation['fichierCreer'] = true;    }// on applique les permission au fichier créé    $retour = chmod($fichierCheminComplet, $droit);    // var_dump($retour);    $t_infoCreation['permissionAppliquer'] = $retour;    return $t_infoCreation;}//ftp://achachia2003:7130chachia@pool182.seedbox.fr:21/VOD/FilmsArabic/Ahwak.HD.720p.mkv//dav://myvod69800%40netcmail.com:myvod69800@webdav.4shared.com:80/Jupiter.Ascending.avi// recuperation des informations de la source et compte$etat = TRUE;$date_upload = date("Y-m-d");$objet = array();/* * *********** recuperer les informations de host-user *********************** */try {    $sql = " SELECT * FROM  CompteVod  WHERE  code_user=:param";    $stmt = $cxn->prepare($sql);    $stmt->bindParam(':param', $_SESSION ['user_admin'] ['code_user']);    $stmt->execute();    $enregistrement = $stmt->fetch();    $host = $enregistrement['host'];    $port = $enregistrement['port'];    $protocole = $enregistrement['protocole'];    $user = $enregistrement['user'];    $password = $enregistrement['password'];} catch (Exception $e) {    $etat = FALSE;    echo $e->getMessage();}/* * ********************* Supression fichier strm en cas si il existe  ********************************* */if (isset($_POST['titre_precedant']) && !empty($_POST['titre_precedant'])) {    $titre_precedant = $_POST['titre_precedant'];    $fichierCheminComplet = $fichierChemin . $titre_precedant . $fichierExtension;    if (file_exists($fichierCheminComplet) == true) {        unlink($fichierCheminComplet);    }}/* * ***************************************Renomer le fichier par le nouveau nom sur le serveur  ********************************************************************** */rename($dir . $nom_fichier_complet, $dir . $nv_nom_fichier);/* * ************************************************************************************************************ */if (!empty($_POST['button_register'])) {    try {        $sql = " INSERT INTO  FichierVod (titre_originale,nom_fichier,date_upload,section_fichier,taille_fichier,id_TMD) VALUES (:param1,:param2,:param3,:param4,:param5,:param6)";        $stmt = $cxn->prepare($sql);        $stmt->bindParam(':param1', $titre_original);        $stmt->bindParam(':param2', $nv_nom_fichier);        $stmt->bindParam(':param3', $date_upload);        $stmt->bindParam(':param4', $section_film);        $stmt->bindParam(':param5', $taille_fichier);        $stmt->bindParam(':param6', $idtmd);        $stmt->execute();        /*         * ********************* Contenu fichier strm Kodi ************************************ */        // creation fichier strm sur le serveur         //  echo $fichierChemin.$titre_original.$fichierExtension.$fichierContenu.$droit;         $fichierContenu = $protocole . '://' . $user . ':' . $password . '@' . $host . ':' . $port . $source_fichier . $nv_nom_fichier;        $t_infoCreation = creerFichierStrm($fichierChemin, $titre_original, $fichierExtension, $fichierContenu, $droit);        if ($t_infoCreation['fichierCreer'] != '1' || $t_infoCreation['permissionAppliquer'] != '1') {            $objet ['message_erreur'] [] = $t_infoCreation['fichierCreer'];            $objet ['message_erreur'] [] = $t_infoCreation['permissionAppliquer'];            $etat = FALSE;            $objet ['message_erreur'] [] = 'Probleme dans la creation de fichier strm dans le serveur';            //  var_dump($objet ['message_erreur']);        }        /*         * ************************************************************************************************************* */    } catch (Exception $e) {        echo $e->getMessage();        $etat = FALSE;        $objet ['message_erreur'] [] = 'Probleme dans l\'excution de la requette' . $sql;    }}/* * ********************************************************************************************** */if (!empty($_POST['button_update'])) {    /*     * *********************************Mettre a jour le fichier dans la base de donnees*********************************************************** */    try {        $sql = " UPDATE  FichierVod  SET  titre_originale=:param1,section_fichier=:param2,id_TMD=:param3,nom_fichier =:param4   WHERE id_fichier=:param5";        $stmt = $cxn->prepare($sql);        $stmt->bindParam(':param1', $titre_original);        $stmt->bindParam(':param2', $section_film);        $stmt->bindParam(':param3', $idtmd);        $stmt->bindParam(':param4', $nv_nom_fichier);        $stmt->bindParam(':param5', $id_fichier);        $stmt->execute();    } catch (Exception $e) {        $etat = FALSE;        $objet ['message_erreur'] [] = 'Probleme dans l\'excution de la requette' . $sql;    }    /*     * ********************* Contenu fichier strm Kodi ************************************ */    // creation fichier strm sur le serveur     //  echo $fichierChemin.$titre_original.$fichierExtension.$fichierContenu.$droit;     $droit = 0777;    $fichierExtension = '.strm';    $fichierContenu = $protocole . '://' . $user . ':' . $password . '@' . $host . ':' . $port . $source_fichier . $nv_nom_fichier;    $t_infoCreation = creerFichierStrm($fichierChemin, $titre_original, $fichierExtension, $fichierContenu, $droit);    if ($t_infoCreation['fichierCreer'] != '1' || $t_infoCreation['permissionAppliquer'] != '1') {        $objet ['message_erreur'] [] = $t_infoCreation['fichierCreer'];        $objet ['message_erreur'] [] = $t_infoCreation['permissionAppliquer'];        $etat = FALSE;        $objet ['message_erreur'] [] = 'Probleme dans la creation de fichier strm dans le serveur';        //  var_dump($objet ['message_erreur']);    }    /*     * ************************************************************************************************************* */}if (!empty($_POST['button_delete'])) {    /*     * ****************** Suppression fichier sur le serveur ***************************************** */    $fichierCheminComplet = $dir . $nom_fichier;    if (file_exists($fichierCheminComplet) == true) {        unlink($fichierCheminComplet);    }    /*     * ****************** Suppression enregistrement dans la base de donnees ***************************************** */    if (isset($_POST['id_fichier']) && !empty($_POST['id_fichier'])) {        $id_fichier = $_POST['id_fichier'];        try {            $sql = " DELETE FROM  FichierVod   WHERE id_fichier=:id_fichier";            $stmt = $cxn->prepare($sql);            $stmt->bindParam(':id_fichier', $id_fichier);            $stmt->execute();        } catch (Exception $e) {            $etat = FALSE;            $objet ['message_erreur'] [] = 'Probleme dans l\'excution de la requette' . $sql;        }    }}/* * ******************************************** ***************************************************** */if ($etat) {        $url=$url_espace_admin."/index.php?module=Cartoon&action=all_cartoon&message=success";    } else {   $url=$url_espace_admin."/index.php?module=Cartoon&action=all_cartoon&message=echec";}header("Location:  $url ");exit();?>