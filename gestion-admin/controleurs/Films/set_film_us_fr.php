<?phpsession_start();session_regenerate_id();require_once './../../connection/config_vod.php';ini_set('date.timezone', 'Europe/Paris');/* * *********************** Donnes recus par le navigateur client *************************** */$section_film = $_POST['section_film'];$titre_original = $_POST['titre_original']; // nouveau$nv_nom_fichier = $_POST['nv_nom_fichier']; //nouveau nom complet$taille_fichier = $_POST['taille_fichier'];$nom_fichier_complet = $_POST['nom_fichier_complet']; // ancien nom  complet$idtmd = $_POST['idtmd'];$id_serveur = $_POST['serveur_film'];$langage = 'VF';$droit = 0777;$fichierExtension = '.strm';if ($_SERVER['SERVER_NAME'] == 'localhost') {    $dir = "C:/wamp64/www/MegaTV-Backend/Media-Vod/Films-HD/";    $source_fichier = "C:/wamp64/www/MegaTV-Backend/Media-Vod/Films-HD/";    $fichierChemin = 'C:/wamp64/www/MegaTV-Backend/Kodi_strm/Films-HD/'; } else {    $dir = "/volume1/web/media/Films-HD/";    $source_fichier = '/web/media/Films-HD/';    $fichierChemin = '/volume1/web/Kodi_strm/Films-HD/';}/* * ***************************************************************************************************** */function creerFichierStrm($fichierChemin, $fichierNom, $fichierExtension, $fichierContenu, $droit = "") {    $fichierCheminComplet = $fichierChemin . $fichierNom . $fichierExtension;// création du fichier sur le serveur    $leFichier = fopen($fichierCheminComplet, "wb");    fwrite($leFichier, $fichierContenu);    fclose($leFichier);// la permission    if ($droit == "") {        $droit = 0777;    }// on vérifie que le fichier a bien été créé    $t_infoCreation['fichierCreer'] = false;    if (file_exists($fichierCheminComplet) == true) {        $t_infoCreation['fichierCreer'] = true;    }// on applique les permission au fichier créé    $retour = chmod($fichierCheminComplet, $droit);    // var_dump($retour);    $t_infoCreation['permissionAppliquer'] = $retour;    return $t_infoCreation;}function InsertGenreMovie($id,$name) {    global $cxn;    try {        $sql = " INSERT INTO  ListeGenreMovieTmdb (id_Tmdb,nom_genre) VALUES ('" . $id . "','" . $name . "') ";        $resultat = $cxn->prepare($sql);        $resultat->execute();    } catch (Exception $e) {        echo $e->getMessage();    }}/* * ******************************************************************************************* */$json_source = file_get_contents('https://api.themoviedb.org/3/movie/' . $idtmd . '?api_key=cf673ba3b2a3baceeeefa90d7460cd10&language=fr');// Décode le JSON$json_data = json_decode($json_source);$genres = '';foreach ($json_data->genres as $key => $value) {    $genres.= $value->name . ',';    /*     * *********** Check genre film dans la table *********************** */    try {        $sql = " SELECT *  FROM  ListeGenreMovieTmdb  WHERE  nom_genre='" . $value->name . "'  ";        $select = $cxn->query($sql);        $nb = $select->rowCount();        if ($nb <= 0) {            InsertGenreMovie($value->id, $value->name);        }    } catch (Exception $e2) {        echo $e2->getMessage();    }    /*     * ************************************************************* */}$genres = substr($genres, 0, -1);/* * ************************************************************************************************************************* *///ftp://achachia2003:7130chachia@pool182.seedbox.fr:21/VOD/FilmsArabic/Ahwak.HD.720p.mkv//dav://myvod69800%40netcmail.com:myvod69800@webdav.4shared.com:80/Jupiter.Ascending.avi// recuperation des informations de la source et compte$etat = TRUE;$date_upload = date("Y-m-d");$objet = array();/* * **************** Recuperer url serveur ****************************************** */try {    $sql = " SELECT url_serveur FROM  ListeServeursVod  WHERE  id_serveur=:param";    $stmt = $cxn->prepare($sql);    $stmt->bindParam(':param', $id_serveur);    $stmt->execute();    $enregistrement = $stmt->fetch();    $url_serveur = $enregistrement['url_serveur'];} catch (Exception $ex) {    $etat = FALSE;    echo $ex->getMessage();}$url = $url_serveur . '/Films-HD/' . $nv_nom_fichier;/* * *********** recuperer les informations de host-user *********************** */try {    $sql = " SELECT * FROM  CompteVod  WHERE  code_user=:param";    $stmt = $cxn->prepare($sql);    $stmt->bindParam(':param', $_SESSION ['user_admin'] ['code_user']);    $stmt->execute();    $enregistrement = $stmt->fetch();    $host = $enregistrement['host'];    $port = $enregistrement['port'];    $protocole = $enregistrement['protocole'];    $user = $enregistrement['user'];    $password = $enregistrement['password'];} catch (Exception $e1) {    $etat = FALSE;    echo $e1->getMessage();}/* * ********************* Supression fichier strm en cas si il existe  ********************************* */if (isset($_POST['titre_precedant']) && !empty($_POST['titre_precedant'])) {    $titre_precedant = $_POST['titre_precedant'];    $fichierCheminComplet = $fichierChemin . $titre_precedant . $fichierExtension;    if (file_exists($fichierCheminComplet) == true) {        unlink($fichierCheminComplet);    }}/* * ************************************************************************************************************ */if (!empty($_POST['button_register'])) {    try {      //  $sql = " INSERT INTO  FichierVod (titre_originale,nom_fichier,date_upload,section_fichier,taille_fichier,id_TMD,langage,id_serveur,url,genre) VALUES (:param1,:param2,:param3,:param4,:param5,:param6,:param7,:param8,:param9,:param10)";              $sql = " INSERT INTO  FichierVod (titre_originale,nom_fichier,date_upload,section_fichier,taille_fichier,id_TMD,langage,id_serveur,url,genre)"                 . " VALUES ('".$titre_original."','".$nv_nom_fichier."','".$date_upload."','".$section_film."','".$taille_fichier."','".$idtmd."','".$langage."','".$id_serveur."','".$url."','".$genres."')";                  echo $sql;        $stmt = $cxn->prepare($sql);      /*  $stmt->bindParam(':param1', $titre_original);        $stmt->bindParam(':param2', $nv_nom_fichier);        $stmt->bindParam(':param3', $date_upload);        $stmt->bindParam(':param4', $section_film);        $stmt->bindParam(':param5', $taille_fichier);        $stmt->bindParam(':param6', $idtmd);        $stmt->bindParam(':param7', $langage);        $stmt->bindParam(':param8', $id_serveur);        $stmt->bindParam(':param9', $url);        $stmt->bindParam(':param10', $genres);*/        $stmt->execute();        /*         * ********************* Contenu fichier strm Kodi ************************************ */        // creation fichier strm sur le serveur        //  echo $fichierChemin.$titre_original.$fichierExtension.$fichierContenu.$droit;        $fichierContenu = $protocole . '://' . $user . ':' . $password . '@' . $host . ':' . $port . $source_fichier . $nv_nom_fichier;        $t_infoCreation = creerFichierStrm($fichierChemin, $titre_original, $fichierExtension, $fichierContenu, $droit);        if ($t_infoCreation['fichierCreer'] != '1' || $t_infoCreation['permissionAppliquer'] != '1') {            $objet ['message_erreur'] [] = $t_infoCreation['fichierCreer'];            $objet ['message_erreur'] [] = $t_infoCreation['permissionAppliquer'];            $etat = FALSE;            $objet ['message_erreur'] [] = 'Probleme dans la creation de fichier strm dans le serveur';            //  var_dump($objet ['message_erreur']);        }        /*         * ***************************************Renomer le fichier par le nouveau nom sur le serveur  ********************************************************************** */        rename($dir . $nom_fichier_complet, $dir . $nv_nom_fichier);    } catch (Exception $e2) {                echo "jfkbjkbklz";        echo $e2->getMessage() + "toto";        $etat = FALSE;        $objet ['message_erreur'] [] = 'Probleme dans l\'excution de la requette' . $sql;    }}/* * ********************************************************************************************** */if (!empty($_POST['button_update'])) {    if (isset($_POST['id_fichier']) && !empty($_POST['id_fichier'])) {        $id_fichier = $_POST['id_fichier'];    }    /*     * *********************************Mettre a jour le fichier dans la base de donnees*********************************************************** */    try {                $sql = " UPDATE  FichierVod  SET  titre_originale=:param1,section_fichier=:param2,id_TMD=:param3,nom_fichier =:param4,url=:param6,genre=:param7,id_serveur=:param8   WHERE id_fichier=:param5";        $stmt = $cxn->prepare($sql);        $stmt->bindParam(':param1', $titre_original);        $stmt->bindParam(':param2', $section_film);        $stmt->bindParam(':param3', $idtmd);        $stmt->bindParam(':param4', $nv_nom_fichier);        $stmt->bindParam(':param5', $id_fichier);        $stmt->bindParam(':param6', $url);        $stmt->bindParam(':param7', $genres);        $stmt->bindParam(':param8', $id_serveur);        $stmt->execute();            } catch (Exception $e3) {        echo $e3->getMessage();        $etat = FALSE;        $objet ['message_erreur'] [] = 'Probleme dans l\'excution de la requette' . $sql;    }    /*     * ********************* Contenu fichier strm Kodi ************************************ */    // creation fichier strm sur le serveur    //  echo $fichierChemin.$titre_original.$fichierExtension.$fichierContenu.$droit;    $droit = 0777;    $fichierExtension = '.strm';    $fichierContenu = $protocole . '://' . $user . ':' . $password . '@' . $host . ':' . $port . $source_fichier . $nv_nom_fichier;    $t_infoCreation = creerFichierStrm($fichierChemin, $titre_original, $fichierExtension, $fichierContenu, $droit);    if ($t_infoCreation['fichierCreer'] != '1' || $t_infoCreation['permissionAppliquer'] != '1') {        $objet ['message_erreur'] [] = $t_infoCreation['fichierCreer'];        $objet ['message_erreur'] [] = $t_infoCreation['permissionAppliquer'];        $etat = FALSE;        $objet ['message_erreur'] [] = 'Probleme dans la creation de fichier strm dans le serveur';        //  var_dump($objet ['message_erreur']);    }    /*     * ***************************************Renomer le fichier par le nouveau nom sur le serveur  ********************************************************************** */    rename($dir . $nom_fichier_complet, $dir . $nv_nom_fichier);}if (!empty($_POST['button_delete'])) {    /*     * ****************** Suppression fichier sur le serveur ***************************************** */    $fichierCheminComplet = $dir . $nom_fichier_complet;    if (file_exists($fichierCheminComplet) == true) {        unlink($fichierCheminComplet);    }    /*     * ****************** Suppression enregistrement dans la base de donnees ***************************************** */    if (isset($_POST['id_fichier']) && !empty($_POST['id_fichier'])) {        $id_fichier = $_POST['id_fichier'];        try {            $sql = " DELETE FROM  FichierVod   WHERE id_fichier=:id_fichier";            $stmt = $cxn->prepare($sql);            $stmt->bindParam(':id_fichier', $id_fichier);            $stmt->execute();        } catch (Exception $e4) {            echo $e4->getMessage();            $etat = FALSE;            $objet ['message_erreur'] [] = 'Probleme dans l\'excution de la requette' . $sql;        }    }}/* * ******************************************** ***************************************************** */if ($etat) {    $url = $url_espace_admin . "/index.php?module=Films&action=all_films&message=success";} else {    $url = $url_espace_admin . "/index.php?module=Films&action=all_films&message=echec";}header("Location:  $url ");exit();?>